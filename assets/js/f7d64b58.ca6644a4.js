"use strict";(self.webpackChunkconflux_docs=self.webpackChunkconflux_docs||[]).push([[871],{86010:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var a=t(85893),s=t(11151);const o={sidebar_position:4,title:"Nonce Management",displayed_sidebar:"coreSidebar",keywords:["transaction","nonce"]},i=void 0,c={id:"core/core-space-basics/transactions/nonce",title:"Nonce Management",description:"In Conflux, each account has a nonce value, representing the number of transactions executed by that account. This value can be obtained using the RPC method cfxgetNextNonce. The nonce field in a transaction is used to specify the execution order, with lower nonce values indicating earlier execution. Typically, you can directly use this value as the nonce for the next transaction.",source:"@site/docs/core/core-space-basics/transactions/nonce.md",sourceDirName:"core/core-space-basics/transactions",slug:"/core/core-space-basics/transactions/nonce",permalink:"/docs/core/core-space-basics/transactions/nonce",draft:!1,unlisted:!1,editUrl:"https://github.com/Conflux-Chain/conflux-documentation/edit/main/docs/core/core-space-basics/transactions/nonce.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"Nonce Management",displayed_sidebar:"coreSidebar",keywords:["transaction","nonce"]},sidebar:"coreSidebar",previous:{title:"Transaction Fee",permalink:"/docs/core/core-space-basics/transactions/transaction-fee"},next:{title:"Transaction Lifecycle",permalink:"/docs/core/core-space-basics/transactions/lifecycle"}},r={},d=[{value:"Nonce Mechanism",id:"nonce-mechanism",level:2},{value:"Issues Caused by Improper Nonce Usage",id:"issues-caused-by-improper-nonce-usage",level:2},{value:"Discarded Due to a Too Stale Nonce",id:"discarded-due-to-a-too-stale-nonce",level:3},{value:"Tx With Same Nonce Already Inserted",id:"tx-with-same-nonce-already-inserted",level:3},{value:"discarded due to in too distant future",id:"discarded-due-to-in-too-distant-future",level:3},{value:"Unable to Retrieve Transaction Receipt After Sending",id:"unable-to-retrieve-transaction-receipt-after-sending",level:3},{value:"Rapid Transaction Processing through Manual Nonce Management",id:"rapid-transaction-processing-through-manual-nonce-management",level:2},{value:"FAQs",id:"faqs",level:2},{value:"How to get the correct nonce?",id:"how-to-get-the-correct-nonce",level:3},{value:"How and When Does the Nonce Value Change in Transactions?",id:"how-and-when-does-the-nonce-value-change-in-transactions",level:3},{value:"If you want to send transactions in batches, how to manage nonce?",id:"if-you-want-to-send-transactions-in-batches-how-to-manage-nonce",level:3},{value:"Why doesn&#39;t the account&#39;s nonce increase immediately after transaction is packed into a block?",id:"why-doesnt-the-accounts-nonce-increase-immediately-after-transaction-is-packed-into-a-block",level:3}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["In Conflux, each account has a nonce value, representing the number of transactions executed by that account. This value can be obtained using the RPC method ",(0,a.jsx)(n.a,{href:"/docs/core/build/json-rpc/cfx-namespace/#cfx_getnextnonce",children:(0,a.jsx)(n.code,{children:"cfx_getNextNonce"})}),". The nonce field in a transaction is used to specify the execution order, with lower nonce values indicating earlier execution. Typically, you can directly use this value as the nonce for the next transaction."]}),"\n",(0,a.jsx)(n.p,{children:"However, in scenarios with high network transaction volume (congestion) or when quick transaction submission is required, obtaining the nonce value becomes more complex. This article will provide a detailed explanation of the nonce update mechanism and how to manage transaction nonces in special circumstances."}),"\n",(0,a.jsx)(n.h2,{id:"nonce-mechanism",children:"Nonce Mechanism"}),"\n",(0,a.jsxs)(n.p,{children:["Here are some details about the ",(0,a.jsx)(n.strong,{children:"nonce mechanism"}),":"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"The execution of transactions on the blockchain is in the order of account nonce from small to large."}),"\n",(0,a.jsx)(n.li,{children:"The initial value of nonce is 0, and the nonce is incremented by 1 for each transaction execution."}),"\n",(0,a.jsx)(n.li,{children:"The nonce cannot be reused."}),"\n",(0,a.jsxs)(n.li,{children:["The nonce cannot be skipped: Suppose that the current nonce of an account is n. If the nonce of the transaction is m such that m > n, then the transaction ",(0,a.jsx)(n.strong,{children:"will not be executed"})," until all ",(0,a.jsx)(n.strong,{children:"transactions with nonce < m have been executed"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["After the transaction is sent via the ",(0,a.jsx)(n.a,{href:"/docs/core/build/json-rpc/cfx-namespace#cfx_sendrawtransaction",children:(0,a.jsx)(n.code,{children:"cfx_sendRawTransaction"})})," method, it will ",(0,a.jsx)(n.strong,{children:"not be executed immediately"}),". You must wait for the miner to pack it first. Once packed, it will be executed with a delay of 5 epochs. After the transaction is executed, the nonce of the account will be increased by one."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"issues-caused-by-improper-nonce-usage",children:"Issues Caused by Improper Nonce Usage"}),"\n",(0,a.jsx)(n.p,{children:"Setting the nonce incorrectly when sending transactions can result in transaction failures or getting stuck in the transaction pool, preventing it from being packaged and executed. Below are some common error messages and their corresponding solutions."}),"\n",(0,a.jsx)(n.h3,{id:"discarded-due-to-a-too-stale-nonce",children:"Discarded Due to a Too Stale Nonce"}),"\n",(0,a.jsx)(n.p,{children:"If the nonce of a newly sent transaction is less than the current nonce of the account, the transaction will be rejected, and an error message like the following will be returned:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'"\\"Transaction 0x0101010110 is discarded due to a too stale nonce\\""\n'})}),"\n",(0,a.jsx)(n.p,{children:"This error indicates that the nonce value used is outdated or has been reused, and it needs to be updated to the latest nonce value."}),"\n",(0,a.jsx)(n.h3,{id:"tx-with-same-nonce-already-inserted",children:"Tx With Same Nonce Already Inserted"}),"\n",(0,a.jsx)(n.p,{children:"If a transaction is sent to the transaction pool but has not been executed yet, sending another transaction with the same nonce will result in an error message like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'"Tx with the same nonce already inserted. To replace it, you need to specify a gas price > {}""\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In this case, you should wait for the transaction in the pool to be executed. If you want to replace the transaction in the pool, you need to set a ",(0,a.jsx)(n.strong,{children:"higher gas price"})," and resend it."]}),"\n",(0,a.jsx)(n.p,{children:"Sometimes, the error message may also be:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'"\\"tx already exist\\""\n'})}),"\n",(0,a.jsx)(n.p,{children:"The handling is the same as above."}),"\n",(0,a.jsx)(n.h3,{id:"discarded-due-to-in-too-distant-future",children:"discarded due to in too distant future"}),"\n",(0,a.jsx)(n.p,{children:"If the nonce value for a transaction is too large, exceeding the user's current nonce by more than 2000, an error message will be returned:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'"\\"Transaction 0x0101010101010101 is discarded due to in too distant future\\""\n'})}),"\n",(0,a.jsx)(n.p,{children:"Solution: Use the correct nonce value when sending the transaction."}),"\n",(0,a.jsxs)(n.p,{children:["In addition to nonce misconfiguration causing transaction failures, there are other scenarios as well. For more details, refer to ",(0,a.jsx)(n.a,{href:"/docs/core/core-space-basics/transactions/send-tx-error",children:"Sending Transaction Errors"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"unable-to-retrieve-transaction-receipt-after-sending",children:"Unable to Retrieve Transaction Receipt After Sending"}),"\n",(0,a.jsx)(n.p,{children:"There is a situation where, after sending a transaction, the receipt cannot be obtained for an extended period. This is typically due to the transaction using non-consecutive nonces. In such cases, the transaction gets stuck in the transaction pool, awaiting the execution of prior transactions."}),"\n",(0,a.jsx)(n.p,{children:"For example, if the account's current nonce is 1 and you send a transaction with nonce 5, it will be stuck in the transaction pool, waiting for transactions with nonces 1, 2, 3, and 4 to be sent and executed."}),"\n",(0,a.jsx)(n.p,{children:"To ensure the execution of this transaction, you need to send transactions with nonces 1, 2, 3, and 4 to the transaction pool. Once these transactions are packaged, the transaction with nonce 5 will automatically be included and executed."}),"\n",(0,a.jsxs)(n.p,{children:["For more information on pending transactions, refer to ",(0,a.jsx)(n.a,{href:"/docs/core/core-space-basics/transactions/why-transaction-is-pending",children:"Transaction Pending"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"rapid-transaction-processing-through-manual-nonce-management",children:"Rapid Transaction Processing through Manual Nonce Management"}),"\n",(0,a.jsxs)(n.p,{children:["In most situations, transactions are sent sequentially: sending one transaction, waiting for it to be executed, and then sending the next. In such cases, ",(0,a.jsx)(n.code,{children:"cfx_getNextNonce"})," can be used directly to obtain the nonce for each transaction. However, this method has a slower processing time, typically averaging around 15 seconds per transaction."]}),"\n",(0,a.jsx)(n.p,{children:"For rapid transaction processing, managing nonce values manually is essential. The general steps for this approach are:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Initial Nonce Retrieval"}),": Obtain the current nonce of your account, referred to as ",(0,a.jsx)(n.code,{children:"nextNonce"}),", before beginning the transaction process."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Transaction Submission"}),": For each transaction:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Use ",(0,a.jsx)(n.code,{children:"nextNonce"})," for the transaction."]}),"\n",(0,a.jsxs)(n.li,{children:["After transaction is successful sent to RPC nodes, increment ",(0,a.jsx)(n.code,{children:"nextNonce"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"Record the hash and nonce of each transaction."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Repeated Execution"}),": Continue step 2 for multiple transactions."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Transaction Monitoring"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Use ",(0,a.jsx)(n.code,{children:"cfx_getTransactionByHash"})," and ",(0,a.jsx)(n.code,{children:"cfx_getTransactionReceipt"})," for transaction status updates."]}),"\n",(0,a.jsx)(n.li,{children:"If a receipt is confirmed, stop monitoring that transaction."}),"\n",(0,a.jsx)(n.li,{children:"If a transaction is dropped or reverted, resend it using the same nonce."}),"\n",(0,a.jsxs)(n.li,{children:["For delayed transactions, possibly due to network congestion, consider increasing ",(0,a.jsx)(n.code,{children:"gasPrice"})," and resending them."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Additional Considerations"}),":"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Pending Transaction Management"}),": Aim to keep pending transactions in the pool to a manageable number, ideally between 100-200. Exceeding this can complicate handling if transactions are delayed or reverted."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Sufficient Funds"}),": Ensure the account has adequate CFX for both the transfer amount and transaction fees to prevent transaction processing delays."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Multiple Accounts for Increased Speed (for certain situations)"}),": Using several accounts in parellel for transactions can further enhance processing speed."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"faqs",children:"FAQs"}),"\n",(0,a.jsx)(n.h3,{id:"how-to-get-the-correct-nonce",children:"How to get the correct nonce?"}),"\n",(0,a.jsxs)(n.p,{children:["Through the  ",(0,a.jsx)(n.a,{href:"/docs/core/build/json-rpc/cfx-namespace/#cfx_getnextnonce",children:(0,a.jsx)(n.code,{children:"cfx_getNextNonce"})})," RPC, the next available nonce of an account can be obtained. The used nonce cannot be used again. The transaction will not be packaged if using a nonce with a value greater than the current nonce."]}),"\n",(0,a.jsx)(n.h3,{id:"how-and-when-does-the-nonce-value-change-in-transactions",children:"How and When Does the Nonce Value Change in Transactions?"}),"\n",(0,a.jsxs)(n.p,{children:["The nonce value in a transaction increments by 1 upon the transaction's execution, regardless of whether the transaction succeeds or fails. If you query the nonce using ",(0,a.jsx)(n.a,{href:"/docs/core/build/json-rpc/cfx-namespace/#cfx_getnextnonce",children:(0,a.jsx)(n.code,{children:"cfx_getNextNonce"})})," after sending a transaction, it may appear unchanged. This unchanged status occurs because the transaction is either still in the transaction pool pending inclusion in a block, or it has been included in a block but is in a 'defer' state awaiting execution."]}),"\n",(0,a.jsxs)(n.p,{children:["Refer to ",(0,a.jsx)(n.a,{href:"/docs/core/core-space-basics/transactions/nonce#nonce-mechanism",children:"nonce mechanism"})," for more example."]}),"\n",(0,a.jsx)(n.h3,{id:"if-you-want-to-send-transactions-in-batches-how-to-manage-nonce",children:"If you want to send transactions in batches, how to manage nonce?"}),"\n",(0,a.jsx)(n.p,{children:"When sending transactions in batches, you need to manually manage the nonce. Every time you send a transaction, the nonce is manually incremented by one.\nIn this case, for a failed transaction of which nonce is not used, you need to manually adjust the transaction parameters to resend it.\nTherefore, you need to keep all transaction hashes and monitor the status of the transactions when sending in batches."}),"\n",(0,a.jsx)(n.h3,{id:"why-doesnt-the-accounts-nonce-increase-immediately-after-transaction-is-packed-into-a-block",children:"Why doesn't the account's nonce increase immediately after transaction is packed into a block?"}),"\n",(0,a.jsx)(n.p,{children:"The account's nonce does not increase immediately after a transaction appears on chain. Instead, the nonce increases after the transaction is packaged and executed."})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>c,a:()=>i});var a=t(67294);const s={},o=a.createContext(s);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);