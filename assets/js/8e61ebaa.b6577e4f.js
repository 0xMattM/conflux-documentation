"use strict";(self.webpackChunkconflux_docs=self.webpackChunkconflux_docs||[]).push([[602],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(n),u=a,m=d["".concat(l,".").concat(u)]||d[u]||h[u]||r;return n?o.createElement(m,s(s({ref:t},p),{},{components:n})):o.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,s=new Array(r);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:a,s[1]=i;for(var c=2;c<r;c++)s[c]=n[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},5091:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var o=n(7462),a=(n(7294),n(3905));const r={sidebar_position:2,title:"SponsorWhitelistControl"},s=void 0,i={unversionedId:"core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control",id:"core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control",title:"SponsorWhitelistControl",description:"Overview",source:"@site/docs/core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control.md",sourceDirName:"core/learn/core-space-basics/internal-contracts",slug:"/core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control",permalink:"/docs/core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control",draft:!1,editUrl:"https://github.com/Conflux-Chain/conflux-documentation/edit/main/docs/core/learn/core-space-basics/internal-contracts/sponsor-whitelist-control.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"SponsorWhitelistControl"},sidebar:"tutorialSidebar",previous:{title:"AdminControl",permalink:"/docs/core/learn/core-space-basics/internal-contracts/admin"},next:{title:"Staking",permalink:"/docs/core/learn/core-space-basics/internal-contracts/staking"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Sponsorship Replacement",id:"sponsorship-replacement",level:2},{value:"Add Sponsor Balance",id:"add-sponsor-balance",level:2},{value:"Whitelist maintenance",id:"whitelist-maintenance",level:2},{value:"Examples",id:"examples",level:2}],p={toc:c},d="wrapper";function h(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Conflux implements a sponsorship mechanism to subsidize the usage of smart contracts. Thus, a new account with zero balance is able to call smart contracts as long as the execution is sponsored (usually by the operator of Dapps). The built-in SponsorControl contract is introduced to record the sponsorship information of smart contracts. "),(0,a.kt)("p",null,"When a message call happens, Conflux does not check sponsorship again. For example, if normal address ",(0,a.kt)("inlineCode",{parentName:"p"},"A")," calls contract ",(0,a.kt)("inlineCode",{parentName:"p"},"B")," and contract ",(0,a.kt)("inlineCode",{parentName:"p"},"B")," calls contract ",(0,a.kt)("inlineCode",{parentName:"p"},"C"),", Conflux only checks whether address ",(0,a.kt)("inlineCode",{parentName:"p"},"A")," is sponsored by contract ",(0,a.kt)("inlineCode",{parentName:"p"},"B"),". If ",(0,a.kt)("inlineCode",{parentName:"p"},"A")," is sponsored, ",(0,a.kt)("inlineCode",{parentName:"p"},"B")," will afford all the gas and/or collateral during the transaction execution, including the message call from ",(0,a.kt)("inlineCode",{parentName:"p"},"B")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"C"),". In other words, only a transaction sender could be sponsored.  "),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"SponsorControl")," contract keeps the following information for each user-established contract:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_for_gas"),": this is the account that provides the subsidy for gas consumption;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_for_collateral"),": this is the account that provides the subsidy for collateral for storage;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_gas"),": this is the balance of subsidy available for gas consumption;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_collateral"),": this is the balance of subsidy available for collateral for storage;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_limit_for_gas_fee"),": this is the upper bound for the gas fee subsidy paid for every sponsored transaction;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"whitelist"),": this is the list of normal accounts that are eligible for the subsidy, where a special all-zero address refers to all normal accounts. Only the contract itself and the admin have the authority to change this list.")),(0,a.kt)("p",null,"There are two resources that can be sponsored: gas consumption and storage collateral."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("em",{parentName:"li"},"For gas consumption"),": If a transaction calls a contract with non-empty ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_for_gas")," and the sender is in the ",(0,a.kt)("inlineCode",{parentName:"li"},"whitelist")," of the contract and the gas fee specified by the transaction is within the ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_limit_for_gas_fee"),", the gas consumption of the transaction is paid from the ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_gas")," of the contract (if it is sufficient) rather than from the sender\u2019s balance, and the execution of the transaction would fail if the ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_gas")," cannot afford the gas consumption. Otherwise, the sender should pay for the gas consumption."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("em",{parentName:"li"},"For storage collateral"),": If a transaction calls a contract with non-empty ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_for_collateral")," and the sender is in the ",(0,a.kt)("inlineCode",{parentName:"li"},"whitelist")," of the contract,  the collateral for storage incurred in the execution of the transaction is deducted from ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_collateral")," of the contract, and the owner of those modified storage entries is set to the contract address accordingly. Otherwise, the sender should pay for the collateral for storage incurred in the execution.")),(0,a.kt)("p",null,"When a contract is created, its ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_gas")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_collateral")," will be initialized by zero address, and the sponsor balance will be initialized by 0. Both sponsorship for gas and for collateral can be updated by calling the SponsorControl contract. The current sponsor can call this contract to transfer funds to increase the sponsor balances directly, and the current sponsor for gas is also allowed to increase the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_limit_for_gas_fee")," without transferring new funds. Other normal accounts can replace the current sponsor by calling this contract and providing more funds for sponsorship."),(0,a.kt)("h2",{id:"sponsorship-replacement"},"Sponsorship Replacement"),(0,a.kt)("p",null,"To replace the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_gas")," of a contract, the new sponsor should call function ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForGas(address contractAddr, uint upperBound)")," and transfer to the internal contract a fund. The following conditions are required to replace sponsor for gas:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The transferred fund should more than the current ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_gas")," of the contract."),(0,a.kt)("li",{parentName:"ol"},"The new value for ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_limit_for_gas_fee")," (specified the ",(0,a.kt)("inlineCode",{parentName:"li"},"upperBound")," parameter) should be no less than the old sponsor\u2019s limit unless the old ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_balance_for_gas")," cannot afford the old ",(0,a.kt)("inlineCode",{parentName:"li"},"sponsor_limit_for_gas_fee"),"."),(0,a.kt)("li",{parentName:"ol"},"The transferred fund should be >= 1000 times of the new limit, so that it is sufficient to subsidize at least ",(0,a.kt)("inlineCode",{parentName:"li"},"1000")," transactions calling the contract.")),(0,a.kt)("p",null,"If the above conditions are satisfied, the remaining ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_balance_for_gas")," will be refunded to the old ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_gas"),", and the fund transferred to the internal contract will be added to the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_balance_for_gas")," of the contract. Then the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_gas")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_limit_for_gas_fee")," will be updated according to the new sponsor\u2019s specification. Otherwise, an exception will be triggered. "),(0,a.kt)("p",null,"The replacement of ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_collateral")," is similar except that there is no analog of the limit for gas fee. The function is ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForCollateral(address contractAddr)"),". The new sponsor should transfer a fund more than the fund provided by the current sponsor for collateral of the contract. Then the current ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_collateral")," will be fully refunded, i.e. the sum of ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_balance_for_collateral")," and the total collateral for storage used by the contract, and both collateral sponsorship fields are changed as the new sponsor\u2019s request accordingly. "),(0,a.kt)("p",null,"Conflux also allows a contract account to be a sponsor. "),(0,a.kt)("h2",{id:"add-sponsor-balance"},"Add Sponsor Balance"),(0,a.kt)("p",null,"The sponsor can provide additional sponsor balance without sponsorship replacement. In this case, the sponsor should also interact with function ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForGas(address contractAddr, uint upperBound)")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForCollateral(address contractAddr)"),", and meet all the requirements except condition 1. If requirements are satisfied, the transferred fund will be added to sponsor balance and the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_limit_for_gas_fee")," will be updated accordingly."),(0,a.kt)("h2",{id:"whitelist-maintenance"},"Whitelist maintenance"),(0,a.kt)("p",null,"Only the contract itself or contract admin can update the contract whitelist. The sponsors have no rights for changing whitelist. "),(0,a.kt)("p",null,"A contract can call function ",(0,a.kt)("inlineCode",{parentName:"p"},"addPrivilege(address[] memory)")," to any addresses to the whitelist. It means that if the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_gas")," is set, the contract will pay the gas fee for the accounts in the whitelist, and if the ",(0,a.kt)("inlineCode",{parentName:"p"},"sponsor_for_collateral")," is set, the contract will pay the CFS (collateral for storage) for the accounts in the whitelist. The zero address is a special address ",(0,a.kt)("inlineCode",{parentName:"p"},"0x0000000000000000000000000000000000000000"),". If this address is added to whitelist, all the transactions calling this contract will be sponsored. A contract can call this function ",(0,a.kt)("inlineCode",{parentName:"p"},"removePrivilege(address[] memory)")," to remove some normal account address from the whitelist. Remove a non-existent address will not cause an error or exception. "),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Corner cases:")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"A contract address can also be added to the whitelist, but it is meaningless because only the transaction sender could be sponsored. ")),(0,a.kt)("p",null,"The admin of a contract can use the interfaces ",(0,a.kt)("inlineCode",{parentName:"p"},"addPrivilegeByAdmin(address contractAddr, address[] memory addresses)")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"removePrivilegeByAdmin(address contractAddr, address[] memory addresses)")," to maintain the whitelist."),(0,a.kt)("h2",{id:"examples"},"Examples"),(0,a.kt)("p",null,"Suppose you have a simple contract like this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-solidity"},'pragma solidity >=0.4.15;\n\nimport "https://github.com/Conflux-Chain/conflux-rust/blob/master/internal_contract/contracts/SponsorWhitelistControl.sol";\n\ncontract CommissionPrivilegeTest {\n    mapping(uint => uint) public ss;\n\n    function add(address account) public payable {\n        SponsorWhitelistControl cpc = SponsorWhitelistControl(0x0888000000000000000000000000000000000001);\n        address[] memory a = new address[](1);\n        a[0] = account;\n        cpc.addPrivilege(a);\n    }\n\n    function remove(address account) public payable {\n        SponsorWhitelistControl cpc = SponsorWhitelistControl(0x0888000000000000000000000000000000000001);\n        address[] memory a = new address[](1);\n        a[0] = account;\n        cpc.removePrivilege(a);\n    }\n\n    function foo() public payable {\n    }\n\n    function par_add(uint start, uint end) public payable {\n        for (uint i = start; i < end; i++) {\n            ss[i] = 1;\n        }\n    }\n}\n')),(0,a.kt)("p",null,"After deploying the contract and the address is ",(0,a.kt)("inlineCode",{parentName:"p"},"contract_addr"),", if someone wants to sponsor the gas consumption, he/she can send a transaction like below:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const PRIVATE_KEY = '0xxxxxxx';\nconst cfx = new Conflux({\n  url: 'https://test.confluxrpc.com',\n  logger: console,\n  networkId: 1,\n});\nconst account = cfx.wallet.addPrivateKey(PRIVATE_KEY); // create account instance\n\nconst sponsor_contract = cfx.InternalContract('SponsorWhitelistControl');\nsponsor_contract.setSponsorForGas(contract_addr, your_upper_bound).sendTransaction({\n  from: account,\n  value: your_sponsor_value\n}).confirmed();\n")),(0,a.kt)("p",null,"As for sponsor the storage collateral, you can simply replace the function ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForGas(contract_addr, your_upper_bound)")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"setSponsorForCollateral(contract_addr)"),"."),(0,a.kt)("p",null,"After that you can maintain the ",(0,a.kt)("inlineCode",{parentName:"p"},"whitelist")," for your contract using ",(0,a.kt)("inlineCode",{parentName:"p"},"addPrivilege")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"removePrivilege"),". The special address ",(0,a.kt)("inlineCode",{parentName:"p"},"0x0000000000000000000000000000000000000000")," with all zeros means everyone is in the ",(0,a.kt)("inlineCode",{parentName:"p"},"whitelist"),". You need to use it carefully."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"you_contract.add(white_list_addr).sendTransaction({\n  from: account,\n})\n\nyou_contract.remove(white_list_addr).sendTransaction({\n  from: account,\n})\n")),(0,a.kt)("p",null,"After that the accounts in ",(0,a.kt)("inlineCode",{parentName:"p"},"whiltelist")," will pay nothing while calling ",(0,a.kt)("inlineCode",{parentName:"p"},"you_contract.foo()")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"you_contract.par_add(1, 10)"),"."))}h.isMDXComponent=!0}}]);