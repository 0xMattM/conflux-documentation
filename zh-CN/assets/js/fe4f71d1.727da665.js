"use strict";(self.webpackChunkconflux_docs=self.webpackChunkconflux_docs||[]).push([[4027],{20120:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var r=t(85893),a=t(11151);const s={displayed_sidebar:"generalSidebar"},c="\u91cd\u5165\u653b\u51fb",i={id:"general/build/smart-contracts/contract-security/reentrancy-attack",title:"\u91cd\u5165\u653b\u51fb",description:"\u91cd\u5165\u653b\u51fb\u662f\u9488\u5bf9\u667a\u80fd\u5408\u7ea6\u6700\u5e38\u89c1\u7684\u653b\u51fb\u7c7b\u578b\u4e4b\u4e00\uff0c\u653b\u51fb\u8005\u5229\u7528\u5408\u7ea6\u7684\u6f0f\u6d1e\u9012\u5f52\u8c03\u7528\u5408\u7ea6\uff0c\u4f7f\u5176\u80fd\u591f\u4ece\u5408\u7ea6\u4e2d\u8f6c\u79fb\u8d44\u4ea7\u6216\u8005\u94f8\u9020\u5927\u91cf\u7684\u4ee3\u5e01\u3002",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/general/build/smart-contracts/contract-security/reentrancy-attack.md",sourceDirName:"general/build/smart-contracts/contract-security",slug:"/general/build/smart-contracts/contract-security/reentrancy-attack",permalink:"/zh-CN/docs/general/build/smart-contracts/contract-security/reentrancy-attack",draft:!1,unlisted:!1,editUrl:"https://crowdin.com/project/conflux/zh-CN",tags:[],version:"current",frontMatter:{displayed_sidebar:"generalSidebar"},sidebar:"generalSidebar",previous:{title:"Access Control Vulnerabilities",permalink:"/zh-CN/docs/general/build/smart-contracts/contract-security/access-control-exploit"},next:{title:"Selector Collision Attack",permalink:"/zh-CN/docs/general/build/smart-contracts/contract-security/selector-collisiion"}},l={},d=[{value:"\u9632\u5fa1\u673a\u5236",id:"\u9632\u5fa1\u673a\u5236",level:2},{value:"\u91cd\u5165\u4fdd\u62a4",id:"\u91cd\u5165\u4fdd\u62a4",level:3},{value:"\u4f7f\u7528Checks-Effects-Interactions\u6a21\u5f0f",id:"\u4f7f\u7528checks-effects-interactions\u6a21\u5f0f",level:3}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,a.a)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{id:"\u91cd\u5165\u653b\u51fb",children:"\u91cd\u5165\u653b\u51fb"}),"\n",(0,r.jsx)(e.p,{children:"\u91cd\u5165\u653b\u51fb\u662f\u9488\u5bf9\u667a\u80fd\u5408\u7ea6\u6700\u5e38\u89c1\u7684\u653b\u51fb\u7c7b\u578b\u4e4b\u4e00\uff0c\u653b\u51fb\u8005\u5229\u7528\u5408\u7ea6\u7684\u6f0f\u6d1e\u9012\u5f52\u8c03\u7528\u5408\u7ea6\uff0c\u4f7f\u5176\u80fd\u591f\u4ece\u5408\u7ea6\u4e2d\u8f6c\u79fb\u8d44\u4ea7\u6216\u8005\u94f8\u9020\u5927\u91cf\u7684\u4ee3\u5e01\u3002"}),"\n",(0,r.jsx)(e.p,{children:"2016\u5e74\uff0cDAO \u5408\u7ea6\u906d\u5230\u91cd\u5165\u653b\u51fb\uff0c\u5bfc\u81f4\u4ece\u5408\u7ea6\u4e2d\u76d7\u53d6\u4e86 3,600,000 ETH\u3002 \u6b64\u4e8b\u4ef6\u5bfc\u81f4\u4ee5\u592a\u574a\u7f51\u7edc\u5206\u53c9\u4e3a\u4e24\u4e2a\u94fe\uff1aETH \u548c ETC\uff08\u4ee5\u592a\u574a\u7ecf\u5178\uff09\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["2022 \u5e74\uff0c\u7b97\u6cd5\u7a33\u5b9a\u5e01\u9879\u76ee Fei \u906d\u5230\u91cd\u5165\u653b\u51fb\uff0c\u5bfc\u81f4\u635f\u5931 8000 \u4e07\u7f8e\u5143\u3002 \u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u5728 ",(0,r.jsx)(e.a,{href:"https://rekt.news/fei-rari-rekt/",children:"\u6b64\u5904"})," \u627e\u5230\u3002"]}),"\n",(0,r.jsx)(e.p,{children:"\u5f53\u5408\u7ea6\u5728\u786e\u4fdd\u5176\u72b6\u6001\u6b63\u786e\u66f4\u65b0\u4e4b\u524d\u8fdb\u884c\u5916\u90e8\u8c03\u7528\u65f6\uff0c\u53ef\u80fd\u4f1a\u53d1\u751f\u91cd\u5165\u653b\u51fb\u3002 Attackers can exploit this by making the vulnerable contract invoke an attacker-controlled contract, which then re-invokes the original contract repeatedly. \u8fd9\u79cd\u91cd\u590d\u8c03\u7528\u53ef\u4ee5\u5728\u6b63\u786e\u66f4\u65b0\u524d\u64cd\u7eb5\u5408\u7ea6\u7684\u72b6\u6001\uff0c\u5bfc\u81f4\u53ef\u80fd\u7684\u8d44\u91d1\u635f\u5931\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["\u8003\u8651\u4e00\u4e2a\u7b80\u5316\u7684 ",(0,r.jsx)(e.code,{children:"FinancialVault"})," \u5408\u7ea6\uff0c\u5b83\u5141\u8bb8\u5b58\u5165\u548c\u53d6\u51fa ETH\uff0c\u7c7b\u4f3c\u4e8e\u94f6\u884c\u8d26\u6237\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'contract FinancialVault {\n    mapping(address => uint256) public balances;\n\n    function depositFunds() external payable {\n        balances[msg.sender] += msg.value;\n    }\n\n    function withdrawFunds() external {\n        uint256 fundsToWithdraw = balances[msg.sender];\n        require(fundsToWithdraw > 0, "No funds available");\n        \n        (bool sent, ) = msg.sender.call{value: fundsToWithdraw}("");\n        require(sent, "Failed to send funds");\n        \n        balances[msg.sender] = 0;\n    }\n\n    function getVaultBalance() external view returns (uint256) {\n        return address(this).balance;\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u5728\u8fd9\u4e2a\u5408\u7ea6\u4e2d\uff0c",(0,r.jsx)(e.code,{children:"withdrawFunds"})," \u65b9\u6cd5\u5bb9\u6613\u53d7\u5230\u91cd\u5165\u653b\u51fb\u3002 \u653b\u51fb\u8005\u53ef\u4ee5\u5229\u7528\u4e00\u4e2a\u8bbe\u8ba1\u7528\u6765\u5728\u63d0\u6b3e\u8fc7\u7a0b\u4e2d\u91cd\u65b0\u8fdb\u5165 ",(0,r.jsx)(e.code,{children:"FinancialVault"})," \u5408\u7ea6\u6765\u8fdb\u884c\u653b\u51fb\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'contract AttackVault {\n    FinancialVault public vault;\n\n    constructor(FinancialVault _vault) {\n        vault = _vault;\n    }\n\n    receive() external payable {\n        if (address(vault).balance >= 1 ether) {\n            vault.withdrawFunds();\n        }\n    }\n\n    function initiateAttack() external payable {\n        require(msg.value == 1 ether, "1 Ether required for the attack");\n        vault.depositFunds{value: 1 ether}();\n        vault.withdrawFunds();\n    }\n\n    function getContractBalance() external view returns (uint256) {\n        return address(this).balance;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u9632\u5fa1\u673a\u5236",children:"\u9632\u5fa1\u673a\u5236"}),"\n",(0,r.jsx)(e.h3,{id:"\u91cd\u5165\u4fdd\u62a4",children:"\u91cd\u5165\u4fdd\u62a4"}),"\n",(0,r.jsxs)(e.p,{children:["\u91cd\u5165\u4fdd\u62a4\u662f\u9632\u6b62\u6b64\u7c7b\u653b\u51fb\u7684\u4e00\u4e2a\u7b80\u5355\u800c\u6709\u6548\u7684\u7b56\u7565\u3002 \u5b83\u6d89\u53ca\u5230\u5728\u51fd\u6570\u5f00\u59cb\u6267\u884c\u65f6\u8bbe\u7f6e\u4e00\u4e2a\u6807\u5fd7\uff0c\u5e76\u5728\u5b8c\u6210\u65f6\u91cd\u7f6e\u5b83\u3002 \u8fd9\u786e\u4fdd\u4e86\u51fd\u6570\u5728\u8fd8\u5728\u8fd0\u884c\u65f6\u4e0d\u80fd\u88ab\u91cd\u65b0\u8fdb\u5165\u3002 OpenZeppelin \u5e93\u63d0\u4f9b\u4e86\u8fd9\u79cd\u6a21\u5f0f\u7684\u5b9e\u73b0\u3002 \u4e0b\u9762\u662f\u5c06\u91cd\u5165\u4fdd\u62a4\u5e94\u7528\u4e8e ",(0,r.jsx)(e.code,{children:"withdrawFunds"})," \u51fd\u6570\u7684\u793a\u4f8b\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'uint256 private _guardCounter = 1;\n\nmodifier nonReentrant() {\n    require(_guardCounter == 1, "Reentrant call");\n    _guardCounter++;\n    _;\n    _guardCounter--;\n}\n\nfunction withdrawFunds() external nonReentrant {\n    uint256 fundsToWithdraw = balances[msg.sender];\n    require(fundsToWithdraw > 0, "No funds available");\n    \n    (bool sent, ) = msg.sender.call{value: fundsToWithdraw}("");\n    require(sent, "Failed to send funds");\n    \n    balances[msg.sender] = 0;\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528checks-effects-interactions\u6a21\u5f0f",children:"\u4f7f\u7528Checks-Effects-Interactions\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.p,{children:"\u8fd9\u4e2a\u6a21\u5f0f\u89c4\u5b9a\uff0c\u51fd\u6570\u5e94\u8be5\u9996\u5148\u6267\u884c\u6240\u6709\u5fc5\u8981\u7684\u68c0\u67e5\uff0c\u66f4\u65b0\u5408\u7ea6\u7684\u72b6\u6001\uff0c\u7136\u540e\u518d\u8fdb\u884c\u4efb\u4f55\u5916\u90e8\u8c03\u7528\u3002 \u9075\u5faa\u8fd9\u4e00\u6a21\u5f0f\u786e\u4fdd\u4e86\u6240\u6709\u72b6\u6001\u66f4\u6539\u5728\u4e0e\u5916\u90e8\u5408\u7ea6\u4ea4\u4e92\u4e4b\u524d\u90fd\u5df2\u5b8c\u6210\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["Learn more: ",(0,r.jsx)(e.a,{href:"https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html",children:"Checks Effects Interactions"})]}),"\n",(0,r.jsxs)(e.p,{children:["\u5728 ",(0,r.jsx)(e.code,{children:"withdrawFunds"})," \u51fd\u6570\u4e2d\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff0c\u5c06\u6d89\u53ca\u5728\u5c1d\u8bd5\u53d1\u9001\u8d44\u91d1\u7ed9\u7528\u6237\u4e4b\u524d\u66f4\u65b0\u7528\u6237\u7684\u4f59\u989d\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-solidity",children:'function withdrawFunds() external {\n    uint256 fundsToWithdraw = balances[msg.sender];\n    require(fundsToWithdraw > 0, "No funds available");\n    \n    balances[msg.sender] = 0;\n    \n    (bool sent, ) = msg.sender.call{value: fundsToWithdraw}("");\n    require(sent, "Failed to send funds");\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u901a\u8fc7\u9075\u5faa\u8fd9\u4e9b\u5b9e\u8df5\uff0c\u667a\u80fd\u5408\u7ea6\u5f00\u53d1\u8005\u53ef\u4ee5\u663e\u8457\u964d\u4f4e\u91cd\u5165\u653b\u51fb\u7684\u98ce\u9669\uff0c\u5e76\u786e\u4fdd\u4ed6\u4eec\u7684\u5408\u7ea6\u5b89\u5168\u3002"})]})}function u(n={}){const{wrapper:e}={...(0,a.a)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(o,{...n})}):o(n)}},11151:(n,e,t)=>{t.d(e,{Z:()=>i,a:()=>c});var r=t(67294);const a={},s=r.createContext(a);function c(n){const e=r.useContext(s);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:c(n.components),r.createElement(s.Provider,{value:e},n.children)}}}]);