"use strict";(self.webpackChunkconflux_docs=self.webpackChunkconflux_docs||[]).push([[7792],{24377:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var c=n(85893),s=n(11151);const o={title:"Selector Collision Attack",displayed_sidebar:"generalSidebar"},r=void 0,i={id:"general/build/smart-contracts/contract-security/selector-collisiion",title:"Selector Collision Attack",description:"The selector collision attack was one of the key reasons behind the hacking of the Poly Network cross-chain bridge.",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/general/build/smart-contracts/contract-security/selector-collisiion.md",sourceDirName:"general/build/smart-contracts/contract-security",slug:"/general/build/smart-contracts/contract-security/selector-collisiion",permalink:"/zh-CN/docs/general/build/smart-contracts/contract-security/selector-collisiion",draft:!1,unlisted:!1,editUrl:"https://crowdin.com/project/conflux/zh-CN",tags:[],version:"current",frontMatter:{title:"Selector Collision Attack",displayed_sidebar:"generalSidebar"},sidebar:"generalSidebar",previous:{title:"\u91cd\u5165\u653b\u51fb",permalink:"/zh-CN/docs/general/build/smart-contracts/contract-security/reentrancy-attack"},next:{title:"GAS \u4f18\u5316",permalink:"/zh-CN/docs/general/build/smart-contracts/gas-optimization/"}},a={},l=[];function d(e){const t={a:"a",code:"code",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(t.p,{children:["The ",(0,c.jsx)(t.strong,{children:"selector collision attack"})," was one of the key reasons behind the hacking of the Poly Network cross-chain bridge."]}),"\n",(0,c.jsxs)(t.p,{children:["In August 2021, the cross-chain bridge contracts of Poly Network on ETH, BSC, and Polygon were hacked, resulting in losses of up to $611 million. This was the largest blockchain hack of 2021 and ranked second in the history of stolen amounts, we can learn more about the detailed attack incidents from ",(0,c.jsx)(t.a,{href:"https://rekt.news/polynetwork-rekt/",children:"this article"}),"."]}),"\n",(0,c.jsxs)(t.p,{children:["In Ethereum smart contracts, a function selector is the first ",(0,c.jsx)(t.code,{children:"4"})," bytes (",(0,c.jsx)(t.code,{children:"8"})," hexadecimal digits) of the hash of the function signature ",(0,c.jsx)(t.code,{children:'"<function name>(<function inputTypes>)"'}),". When a user calls a contract's function, the first ",(0,c.jsx)(t.code,{children:"4"})," bytes of the ",(0,c.jsx)(t.code,{children:"calldata"})," are the target function's selector, which determines which function to call."]}),"\n",(0,c.jsxs)(t.p,{children:["Due to the function selector being only ",(0,c.jsx)(t.code,{children:"4"})," bytes long, it's quite short and prone to collisions: it's relatively easy to find two different functions that share the same function selector. For example, ",(0,c.jsx)(t.code,{children:"mint(address,uint256)"})," and ",(0,c.jsx)(t.code,{children:"cat642998653(address,uint256)"})," have the same selector: ",(0,c.jsx)(t.code,{children:"0x23b872dd"}),"."]}),"\n",(0,c.jsx)(t.p,{children:(0,c.jsx)(t.strong,{children:"Vulnerable Contract Example"})}),"\n",(0,c.jsxs)(t.p,{children:["\u8ba9\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a\u5177\u6709\u6f0f\u6d1e\u7684\u5408\u7ea6\u793a\u4f8b\u6765\u5b66\u4e60\u4e00\u4e0b\u3002 ",(0,c.jsx)(t.code,{children:"SelectorCollisionTest"})," \u5408\u7ea6\u6709\u4e00\u4e2a\u72b6\u6001\u53d8\u91cf ",(0,c.jsx)(t.code,{children:"isCompleted"}),"\uff0c\u521d\u59cb\u503c\u4e3a ",(0,c.jsx)(t.code,{children:"false"}),"\u3002 \u653b\u51fb\u8005\u9700\u8981\u5c06\u5176\u6539\u4e3a ",(0,c.jsx)(t.code,{children:"true"}),"\u3002 \u5408\u7ea6\u4e3b\u8981\u6709 ",(0,c.jsx)(t.code,{children:"2"})," \u4e2a\u51fd\u6570\u3002"]}),"\n",(0,c.jsxs)(t.ol,{children:["\n",(0,c.jsxs)(t.li,{children:["\n",(0,c.jsxs)(t.p,{children:[(0,c.jsx)(t.code,{children:"activateKey()"}),"\uff1a\u653b\u51fb\u8005\u53ef\u4ee5\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u5c06 ",(0,c.jsx)(t.code,{children:"isCompleted"})," \u6539\u4e3a ",(0,c.jsx)(t.code,{children:"true"}),"\uff0c\u5b8c\u6210\u653b\u51fb\u3002 \u7136\u800c\uff0c\u8fd9\u4e2a\u51fd\u6570\u68c0\u67e5 ",(0,c.jsx)(t.code,{children:"msg.sender == address(this)"}),"\uff0c\u610f\u5473\u7740\u8c03\u7528\u8005\u5fc5\u987b\u662f\u5408\u7ea6\u672c\u8eab\u3002"]}),"\n"]}),"\n",(0,c.jsxs)(t.li,{children:["\n",(0,c.jsxs)(t.p,{children:[(0,c.jsx)(t.code,{children:"triggerAction()"}),"\uff1a\u5b83\u53ef\u4ee5\u8c03\u7528\u5408\u7ea6\u5185\u7684\u51fd\u6570\uff0c\u4f46\u51fd\u6570\u53c2\u6570\u7c7b\u578b\u548c\u76ee\u6807\u51fd\u6570\u4e0d\u5b8c\u5168\u76f8\u540c\uff1a\u76ee\u6807\u51fd\u6570\u7684\u53c2\u6570\u662f ",(0,c.jsx)(t.code,{children:"(bytes)"}),"\uff0c\u800c\u88ab\u8c03\u7528\u7684\u51fd\u6570\u7684\u53c2\u6570\u662f ",(0,c.jsx)(t.code,{children:"(bytes,bytes,uint64)"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-solidity",children:'contract SelectorCollisionTest {\n    bool public isCompleted; // Whether the attack was successful\n\n    // The attacker needs to call this function, but the caller msg.sender must be this contract.\n    function activateKey(bytes memory data) public {\n        require(msg.sender == address(this), "Unauthorized");\n        isCompleted = true;\n    }\n\n    // Vulnerable, the attacker can change the _action variable to collide with the function selector and call the target function to complete the attack.\n    function triggerAction(bytes memory _action, bytes memory data, bytes memory extraData, uint64 timestamp) public returns(bool executed){\n        (executed, ) = address(this).call(\n            abi.encodePacked(\n                bytes4(\n                    keccak256(abi.encodePacked(_action, "(bytes,bytes,uint64)")\n                    )\n                ),\n                abi.encode(data, extraData, timestamp)));\n    }\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:(0,c.jsx)(t.strong,{children:"\u653b\u51fb\u65b9\u6cd5"})}),"\n",(0,c.jsxs)(t.p,{children:["\u901a\u8fc7\u5229\u7528 ",(0,c.jsx)(t.code,{children:"triggerAction()"})," \u51fd\u6570\uff0c\u53ef\u4ee5\u8c03\u7528\u5408\u7ea6\u7684 ",(0,c.jsx)(t.code,{children:"activateKey()"})," \u51fd\u6570\uff0c\u76ee\u6807\u662f\u7279\u5b9a\u7684\u9009\u62e9\u5668 ",(0,c.jsx)(t.code,{children:"0x4bb3d55c"}),"\u3002"]}),"\n",(0,c.jsxs)(t.p,{children:["\u5728 ",(0,c.jsx)(t.code,{children:"triggerAction()"})," \u673a\u5236\u4e2d\uff0c\u9009\u62e9\u5668\u6765\u81ea\u4e8e\u5c06 ",(0,c.jsx)(t.code,{children:"_action"})," \u53c2\u6570\u4e0e\u51fd\u6570\u7b7e\u540d ",(0,c.jsx)(t.code,{children:'"(bytes,bytes,uint64)"'})," \u7ed3\u5408\u3002 \u56e0\u6b64\uff0c\u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684 ",(0,c.jsx)(t.code,{children:"_action"})," \u4f7f\u5f97\u8ba1\u7b97\u51fa\u7684\u9009\u62e9\u5668\u5339\u914d ",(0,c.jsx)(t.code,{children:"0x4bb3d55c"}),"\uff0c\u4ece\u800c\u5b9e\u73b0\u653b\u51fb\u76ee\u6807\u3002"]})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,c.jsx)(t,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>i,a:()=>r});var c=n(67294);const s={},o=c.createContext(s);function r(e){const t=c.useContext(o);return c.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),c.createElement(o.Provider,{value:t},e.children)}}}]);